<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Deterministic test data with Faker, FactoryBot, and RSpec</title>
  <meta name="description" content="I get a lot of joy from using Faker and FactoryBot to efficiently generate real-world test data, but its randomness can be a liability when trying to debug c...">

  <link rel="stylesheet" href="/assets/stylesheets/main.css">
  <script src="/assets/javascripts/main.js"></script>

  <link rel="canonical" href="http://island94.org/2019/11/deterministic-test-data-with-faker-factorybot-and-rspec">
  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="http://island94.org/feed.xml">

  

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-870047-1', 'auto');
  ga('send', 'pageview');
</script>

</head>


  <body>

    <nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-links" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Island94.org</a>
    </div>

    <div class="collapse navbar-collapse" id="navbar-collapse-links">
      <form id="search" class="navbar-form navbar-right" action="https://google.com/search" method="get">
        <input class="form-control" name="q" type="hidden" value="site:island94.org">
        <input class="search form-control" role="search" name="q" placeholder="Search with Google" aria-label="Search with Google" results="0" type="text">
        <button class="sr-only" type="submit">Search</button>
      </form>

      <ul class="nav navbar-nav navbar-right">
        <li><a class="page-link" href="/about/">About</a></li>
        <li><a class="page-link" href="/archives/">Archives</a></li>
        <li><a class="page-link" href="/tags/">Tags</a></li>
        <li><a href="/feed.xml"><span class="fa fa-rss"></span> RSS</a></li>
      </ul>
    </div>
  </div>
</nav>


    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"
          
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2019/11/deterministic-test-data-with-faker-factorybot-and-rspec">Deterministic test data with Faker, FactoryBot, and RSpec</a>
    </h1>
    <p class="post-meta text-muted">
      <time datetime="2019-11-30T19:33:00+00:00" itemprop="datePublished">November 30, 2019</time>
      
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I get a lot of joy from using <a href="https://github.com/faker-ruby/faker">Faker</a> and <a href="https://github.com/thoughtbot/factory_bot">FactoryBot</a> to efficiently generate real-world test data, but its randomness can be a liability when trying to debug complicated specs or when setting up systems that require repeatable data across RSpec test runs like <a href="https://percy.io/">Percy’s visual diffs</a>.</p>

<p>Without deterministic test data, generating three new users with <code class="highlighter-rouge">3.times { puts Faker::Name.first_name }</code> would result in <code class="highlighter-rouge">Danny, Solomon, Fabian</code> when run once, then <code class="highlighter-rouge">Jordon, Shawn, Asa</code> when run a second time, then <code class="highlighter-rouge">Bruce, Leonor, Paulette</code> when run a third time.</p>

<p>With deterministic test data, I expect to always generate the same set of names no matter how many times the code is run.  Faker has <a href="https://github.com/faker-ruby/faker#deterministic-random">documented</a> how to configure and seed the random number generator and this can be achieved with:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> 
  <span class="no">Faker</span><span class="o">::</span><span class="no">Config</span><span class="p">.</span><span class="nf">random</span> <span class="o">=</span> <span class="no">Random</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">first_name</span> 
<span class="k">end</span>
</code></pre></div></div>

<p>This script outputs <code class="highlighter-rouge">Zachery, Dawna, Desmond</code> every single time it is run, meaning that it’s deterministic.</p>

<p>Faker’s deterministic configuration can be combined with a FactoryBot <a href="https://github.com/thoughtbot/factory_bot/blob/master/GETTING_STARTED.md#sequences"><code class="highlighter-rouge">sequence</code></a> to always get the same data every time a new factory instance is created. For example, here’s what a deterministic <code class="highlighter-rouge">User</code> factory could look like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/factories/users.rb</span>

<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="no">Faker</span><span class="o">::</span><span class="no">Config</span><span class="p">.</span><span class="nf">random</span> <span class="o">=</span> <span class="no">Random</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
      <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">first_name</span>
    <span class="k">end</span>

    <span class="n">sequence</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="no">Faker</span><span class="o">::</span><span class="no">Config</span><span class="p">.</span><span class="nf">random</span> <span class="o">=</span> <span class="no">Random</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
      <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">last_name</span>
    <span class="k">end</span>

    <span class="n">email</span> <span class="p">{</span> <span class="s2">"</span><span class="si">#{</span><span class="n">first_name</span><span class="p">.</span><span class="nf">parameterize</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">last_name</span><span class="p">.</span><span class="nf">parameterize</span><span class="si">}</span><span class="s2">@example.com"</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="s1">'password123'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Within every sequence, the Faker random number generator is  seeded with <code class="highlighter-rouge">Faker::Config.random = Random.new(n)</code> , where <code class="highlighter-rouge">n</code> is the integer generated by the sequence.</p>

<p>Unfortunately, just using a sequence isn’t completely sufficient when running tests in random order, or inserting new tests or rearranging the tests, as one would expect in an active codebase. FactoryBot sequences are global, meaning that they don’t reset by default between each and every test; a FactoryBot instance during one test run might use a different sequence number than a previous test run.</p>

<p>Therefore, it’s also necessary to rewind FactoryBot sequences after each RSpec example. Place this in your <code class="highlighter-rouge">spec/rails_helper.rb</code> or <code class="highlighter-rouge">spec/support</code> directory:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/support/factory_bot.rb</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">after</span> <span class="k">do</span>
    <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">rewind_sequences</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That’s all you need to combine Faker and FactoryBot to get deterministic test data in your RSpec tests. Have fun!</p>

  </div>

</article>


<hr>

<div class="well">
  Discuss this with me on
  <a href="https://twitter.com/bensheldon"><span class="fa fa-twitter"></span> Twitter</a>
  or suggest a <a href="https://github.com/bensheldon/island94-jekyll/blob/master/_posts/2019-11-30-deterministic-test-data-with-faker-factorybot-and-rspec.md"><span class="fa fa-github-alt"></span> change</a>.
</div>

        </div>
      </div>
    </div>

    <footer class="site-footer">

</footer>


  </body>

</html>
