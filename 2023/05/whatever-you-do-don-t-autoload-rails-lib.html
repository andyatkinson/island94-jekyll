<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Whatever you do, don't autoload Rails `lib/`</title>
  <meta name="description" content="One of the most common problems I encounter consulting on Rails projects is that developers have previously added lib/ to autoload paths and then twisted the...">

  <link rel="stylesheet" href="/assets/stylesheets/main.css">
  <script src="/assets/javascripts/main.js"></script>

  <link rel="canonical" href="https://island94.org/2023/05/whatever-you-do-don-t-autoload-rails-lib">

  <link rel="alternate" type="application/rss+xml" title="Island94.org Posts" href="https://island94.org/feed.xml">
  <link rel="alternate" type="application/rss+xml" title="Island94.org Book Reviews" href="https://island94.org/books.xml">

  

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-870047-1', 'auto');
  ga('send', 'pageview');
</script>

</head>


  <body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link " href="/about/">About</a></li>
        <li class="nav-item"><a class="nav-link " href="/archives/">Archives</a></li>
        <li class="nav-item"><a class="nav-link " href="/books/">Books</a></li>
        <li class="nav-item"><a class="nav-link " href="/tags/">Tags</a></li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Feeds <span class="fa fa-rss"></span>
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <li><a href="/feed.xml" class="dropdown-item">Everything RSS <span class="fa fa-rss"></span></a></li>
            <li><a href="/posts.xml" class="dropdown-item">Posts RSS <span class="fa fa-rss"></span></a></li>
            <li><a href="/books.xml" class="dropdown-item">Books RSS <span class="fa fa-rss"></span></a></li>
          </ul>
        </li>
      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <input id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text">
        <button class="sr-only" type="submit">Search</button>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      — Ben Sheldon's personal blog and <a href="/2012/04/A-Commonplace-Book.html">commonplace book</a>.
    </div>
  </div>
</nav>


    <div class="container container-body">
      


<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2023/05/whatever-you-do-don-t-autoload-rails-lib">Whatever you do, don't autoload Rails `lib/`</a>
    </h1>
    <p class="post-meta text-muted">
      <time datetime="2023-05-02T14:09:00+00:00" itemprop="datePublished">May 2, 2023</time>
      
      



    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>One of the most common problems I encounter consulting on Rails projects is that developers have previously added <code class="language-plaintext highlighter-rouge">lib/</code> to autoload paths and then twisted themselves into knots creating error-prone, project-specific conventions for subsequently un-autoloading a subset of files also in <code class="language-plaintext highlighter-rouge">lib/</code>.</p>

<p>The problem of autoloading <code class="language-plaintext highlighter-rouge">lib/</code> is that there will subsequently be files added to <code class="language-plaintext highlighter-rouge">lib/</code> that shouldn’t be autoloaded; because they should only be provisionally loaded in a certain environment or context, or deferred, for behavioral, performance, or memory reasons. If your project has already enabled autoloading on <code class="language-plaintext highlighter-rouge">lib/</code>, it’s now likely you’ll add additional configuration to un-autoload the new files. These overrides and counter-overrides accumulate over time and become difficult to understand and unwind.</p>

<p><em>Don’t do it. Don’t add your Rails project’s <code class="language-plaintext highlighter-rouge">lib/</code> to autoload paths.</em></p>

<h3 id="how-does-this-happen">How does this happen?</h3>

<p>A growing Rails application will accumulate a lot of ruby classes and files that don’t cleanly fit into the default <code class="language-plaintext highlighter-rouge">app/</code> directories of <code class="language-plaintext highlighter-rouge">controllers</code>, <code class="language-plaintext highlighter-rouge">helpers</code>, <code class="language-plaintext highlighter-rouge">jobs</code>, or <code class="language-plaintext highlighter-rouge">models</code>. Developers should also be creating new directories in <code class="language-plaintext highlighter-rouge">app/*</code> to organize like-with-like files (your <code class="language-plaintext highlighter-rouge">app/services/</code> or <code class="language-plaintext highlighter-rouge">app/merchants/</code>, etc.). That’s ok!</p>

<p>But frequently there are one-off classes that don’t seem to rise to the level of their own directory in <code class="language-plaintext highlighter-rouge">app/</code>. From looking through the cruft of projects like <a href="https://github.com/mastodon/mastodon/tree/c62604b5f69c3ad7f5449e0a7dc26606adebb777/app/lib">Mastadon</a> or applications <a href="https://github.com/codeforamerica/vita-min/tree/2f5faf06f586d1ea3915af262aab7683240f4727/app/lib">I’ve</a> <a href="https://github.com/bensheldon/open311status/blob/2cd70e391770f64d734f462624222fb8f8bc14a4/app/lib/service_requests_pager.rb">worked</a> <a href="https://github.com/bensheldon/open311status/tree/2cd70e391770f64d734f462624222fb8f8bc14a4/app/lib">on</a>, these files look like:</p>

<ul>
  <li>A lone form builder</li>
  <li>POROs (“Plain old Ruby objects”) like <code class="language-plaintext highlighter-rouge">PhoneNumberFormatter</code>, or <code class="language-plaintext highlighter-rouge">ZipCodes</code> or <code class="language-plaintext highlighter-rouge">Seeder</code>, or <code class="language-plaintext highlighter-rouge">Pagination</code>. Objects that serve a single purpose and are largely singletons/identity objects within the application.</li>
  <li>Boilerplate classes for 3rd party gems, e.g. <code class="language-plaintext highlighter-rouge">ApplicationResponder</code> for the <code class="language-plaintext highlighter-rouge">responders gem</code>.</li>
</ul>

<p>That these files accumulate in a project is a fact of life. When choosing where to put them, that’s when things can go wrong.</p>

<p>In a newly built Rails project <code class="language-plaintext highlighter-rouge">lib/</code> looks like the natural place for these. But <code class="language-plaintext highlighter-rouge">lib/</code> has a downside: <code class="language-plaintext highlighter-rouge">lib/</code> is not autoloaded. This can come as a surprise, even to experienced developers, because they have been accustomed to the convenience of autoloaded files in <code class="language-plaintext highlighter-rouge">app/</code>. It’s not difficult to add an explicit <code class="language-plaintext highlighter-rouge">require</code> statement into <code class="language-plaintext highlighter-rouge">application.rb</code> or in an initializer, but that may not be one’s first thought.</p>

<p>That’s when people jump to googling “how to autoload <code class="language-plaintext highlighter-rouge">lib/</code>”. Don’t do it! <code class="language-plaintext highlighter-rouge">lib/</code> should not be autoloaded.</p>

<p>The simplest reason why you shouldn’t autoload <code class="language-plaintext highlighter-rouge">lib/</code>: there will be files that <em>should never</em> be autoloaded, and if you autoload it those other files will now have to be moved or won’t work right. This is when people start twisting their configuration into knots.</p>

<p>What should you do instead?</p>

<h3 id="an-omikase-solution">An omikase solution</h3>

<p>DHH <a href="https://github.com/rails/rails/pull/47843#issuecomment-1515367267">writes</a>:</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">lib/</code> is intended to be for non-app specific library code that just happens to live in the app for now (usually pending extraction into open source or whatever). Everything app specific that’s part of the domain model should live in <code class="language-plaintext highlighter-rouge">app/models</code> (that directory is for POROs as much as ARs)… Stuff like a generic PhoneNumberFormatter is exactly what <code class="language-plaintext highlighter-rouge">lib/</code> is intended for. And if it’s app specific, for some reason, then <code class="language-plaintext highlighter-rouge">app/models</code> is fine.</p>
</blockquote>

<p>The omikase solution is to manually require files from <code class="language-plaintext highlighter-rouge">lib/</code> or use <code class="language-plaintext highlighter-rouge">app/models</code> generically to mean “Domain Models” rather than solely Active Record models. That’s great! Do that.</p>

<h3 id="a-best-practice">A best practice</h3>

<p>Xavier Noria, Zeitwerk’s creator <a href="https://github.com/rails/rails/issues/37835#issuecomment-757367812">writes</a>:</p>

<blockquote>
  <p>The best practice to accomplish that nowadays is to move that code to <code class="language-plaintext highlighter-rouge">app/lib</code>. Only the Ruby code you want to reload, tasks or other auxiliary files are OK in <code class="language-plaintext highlighter-rouge">lib</code>.</p>
</blockquote>

<p>Sidekiq’s Problems and Troubleshooting <a href="https://github.com/sidekiq/sidekiq/wiki/Problems-and-Troubleshooting#autoloading">explains</a>:</p>

<blockquote>
  <p>A <code class="language-plaintext highlighter-rouge">lib/</code> directory will only cause pain. Move the code to <code class="language-plaintext highlighter-rouge">app/lib/</code> and make sure the code inside follows the class/filename conventions.</p>
</blockquote>

<p>The best practice is to create an <code class="language-plaintext highlighter-rouge">app/lib/</code> directory to home these files. <a href="https://github.com/mastodon/mastodon/tree/c62604b5f69c3ad7f5449e0a7dc26606adebb777/app/lib">Mastodon</a> does it, as do <a href="https://github.com/search?type=code&amp;auto_enroll=true&amp;q=path%3A%2F%5Eapp%5C%2Flib%5C%2F.*%5C.rb%2F">many others</a>.</p>

<p>This “best practice” is not without contention, as usually anything in Rails that deviates from omikase does, like RSpec instead of MiniTest or FactoryBot instead of Fixtures. But creating <code class="language-plaintext highlighter-rouge">app/lib</code> as a convention for Rails apps works for me and many others.</p>

<h3 id="really-dont-autoload-lib">Really, don’t autoload <code class="language-plaintext highlighter-rouge">lib/</code></h3>

<p>Whatever path you take, don’t take the path of autoloading <code class="language-plaintext highlighter-rouge">lib/</code>.</p>

  </div>
</article>


<div class="card my-4 text-dark bg-light">
  <div class="card-body">
    <p>
      Discuss this with me on <a href="https://twitter.com/bensheldon"><span class="fa fa-twitter"></span> Twitter</a>
      or suggest a <a href="https://github.com/bensheldon/island94-jekyll/blob/main/_posts/2023-05-02-whatever-you-do-don-t-autoload-rails-lib.md"><span class="fa fa-github-alt"></span> change</a>.
    </p>

    <p>Related Posts:</p>

    <ul>
      
      <li><a href="/2012/12/A-gentle-conceptual-introduction-to-Nodejs.html">A gentle & conceptual introduction to Node.js</a></li>
      
      <li><a href="/2010/09/Making-language-of-meaning.html">Making language of meaning</a></li>
      
      <li><a href="/2007/08/Geekout-Video-on-Maps-for-Cable-Access-TV.html">Geekout: Video on Maps for Cable Access TV</a></li>
      
      <li><a href="/2023/03/how-goodjob-s-mountable-rails-engine-delivers-javascript-importmaps-and-frontend-assets">How GoodJob's mountable Rails Engine delivers Javascript importmaps and frontend assets</a></li>
      
      <li><a href="/2022/07/four-dumb-cringe-tech-interview-stories">Four dumb-cringe tech interview stories</a></li>
      
    </ul>
  </div>
</div>


    </div>

    <footer class="site-footer">

</footer>


  </body>

</html>
